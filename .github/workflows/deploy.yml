name: Deploy Backend to NHN Cloud

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Deploy to NHN Cloud via SSH
              uses: appleboy/ssh-action@v0.1.7
              with:
                  host: ${{ secrets.SERVER_IP }}
                  username: ubuntu
                  key: ${{ secrets.SSH_KEY }}
                  script: |
                      # --- 여기부터 NHN Cloud 서버에서 실행됩니다 ---

                      # (⭐️핵심 해결책) 프로젝트 폴더 전체의 소유자를 'ubuntu'로 강제 변경
                      # sudo를 사용해 root 권한으로 소유권을 변경합니다.
                      sudo chown -R ubuntu:ubuntu /home/ubuntu/fourmen-backend

                      # 배포할 프로젝트 경로로 이동
                      cd ~/fourmen-backend

                      # git pull을 실행하기 전에 이 디렉토리가 안전하다고 설정
                      git config --global --add safe.directory /home/ubuntu/fourmen-backend

                      # 최신 코드 가져오기
                      git pull origin main

                      # Maven 빌드
                      ./mvnw clean package -DskipTests

                      # 기존 실행중인 Spring Boot 종료
                      pkill -f 'java -jar' || true

                      # 새 JAR 실행
                      nohup java -jar target/*.jar > app.log 2>&1 &

                      sleep 30
