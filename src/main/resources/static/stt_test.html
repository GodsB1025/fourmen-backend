<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ STT ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸ (CSRF í¬í•¨)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            background-color: #f4f7f9;
        }
        .container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            flex-grow: 1;
            padding: 12px 18px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            transition: background-color 0.3s;
        }
        #loginButton { background-color: #007bff; }
        #loginButton:hover { background-color: #0056b3; }
        #startButton { background-color: #28a745; }
        #startButton:disabled { background-color: #a5d6a7; cursor: not-allowed; }
        #stopButton { background-color: #dc3545; }
        #stopButton:disabled { background-color: #f8d7da; cursor: not-allowed; }

        #status {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        #error {
            color: #dc3545;
            margin-top: 15px;
            font-weight: bold;
        }
        .info {
            font-size: 12px; color: #666; background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>STT ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸ (CSRF) ğŸ™ï¸</h1>
    <div class="info">
        <strong>âš ï¸ í…ŒìŠ¤íŠ¸ ë°©ë²•:</strong><br>
        1. ë°±ì—”ë“œì— ì‹¤ì œ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.<br>
        2. ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬(F12) > Application > Cookies ì—ì„œ `accessToken`ê³¼ `XSRF-TOKEN` ê°’ì„ ë³µì‚¬í•©ë‹ˆë‹¤.<br>
        3. ì•„ë˜ ì…ë ¥ë€ì— ë¶™ì—¬ë„£ê³  'í…ŒìŠ¤íŠ¸ìš© ì¿ í‚¤ ì„¤ì •' ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.<br>
        4. 'ë…¹ìŒ ì‹œì‘' ë²„íŠ¼ì„ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.
    </div>

    <div class="form-group">
        <label for="accessTokenInput">Access Token</label>
        <input type="text" id="accessTokenInput" placeholder="ë¡œê·¸ì¸ í›„ ë°œê¸‰ë°›ì€ accessToken ê°’ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>
    <div class="form-group">
        <label for="xsrfTokenInput">XSRF-TOKEN (CSRF í† í°)</label>
        <input type="text" id="xsrfTokenInput" placeholder="ë¡œê·¸ì¸ í›„ ë°œê¸‰ë°›ì€ XSRF-TOKEN ê°’ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>
    <button id="loginButton" style="width: 100%; margin-bottom: 20px;">í…ŒìŠ¤íŠ¸ìš© ì¿ í‚¤ ì„¤ì • (í•„ìˆ˜)</button>

    <div class="button-group">
        <button id="startButton">ë…¹ìŒ ì‹œì‘ (íšŒì˜ ID: 1)</button>
        <button id="stopButton" disabled>ë…¹ìŒ ì¤‘ì§€</button>
    </div>

    <div id="status">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
    <div id="error"></div>
</div>

<script>
    // UI ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const accessTokenInput = document.getElementById('accessTokenInput');
    const xsrfTokenInput = document.getElementById('xsrfTokenInput');
    const loginButton = document.getElementById('loginButton');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const statusDiv = document.getElementById('status');
    const errorDiv = document.getElementById('error');

    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
    let socket = null;
    let mediaRecorder = null;
    let audioStream = null;
    const MEETING_ID = 1; // íšŒì˜ IDë¥¼ 1ë¡œ ê³ ì •

    // 'í…ŒìŠ¤íŠ¸ìš© ì¿ í‚¤ ì„¤ì •' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    loginButton.addEventListener('click', () => {
        const accessToken = accessTokenInput.value.trim();
        const xsrfToken = xsrfTokenInput.value.trim();

        if (!accessToken || !xsrfToken) {
            alert('Access Tokenê³¼ XSRF-TOKENì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        document.cookie = `accessToken=${accessToken}; path=/; max-age=3600; SameSite=Lax`;
        document.cookie = `XSRF-TOKEN=${xsrfToken}; path=/; max-age=3600; SameSite=Lax`;

        alert('í…ŒìŠ¤íŠ¸ìš© ì¿ í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ë…¹ìŒì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        console.log('Cookies set:', document.cookie);
    });

    // 'ë…¹ìŒ ì‹œì‘' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    startButton.addEventListener('click', () => {
        // ìƒíƒœ ì´ˆê¸°í™”
        errorDiv.textContent = '';
        updateStatus('ì—°ê²° ì¤‘...', '#ffc107');
        startButton.disabled = true;

        const wsUrl = `ws://localhost:8081/api/ws/audio/${MEETING_ID}`;

        socket = new WebSocket(wsUrl);

        socket.onopen = async () => {
            updateStatus('WebSocket ì—°ê²° ì„±ê³µ. ë§ˆì´í¬ ì ‘ê·¼ ì¤‘...', '#007bff');
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                const options = { mimeType: 'audio/webm;codecs=opus' };
                mediaRecorder = new MediaRecorder(audioStream, options);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && socket?.readyState === WebSocket.OPEN) {
                        socket.send(event.data);
                    }
                };

                mediaRecorder.onstart = () => {
                    updateStatus('ë…¹ìŒ ì¤‘...', '#28a745');
                    stopButton.disabled = false;
                };

                // 1ì´ˆ(1000ms) ëŒ€ì‹  0.4ì´ˆ(400ms) ê°„ê²©ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¶„í• í•˜ì—¬ ì „ì†¡í•©ë‹ˆë‹¤.
                // ì´ë ‡ê²Œ í•˜ë©´ ê° ë°ì´í„° ì¡°ê°ì˜ í¬ê¸°ê°€ ì„œë²„ì˜ ë²„í¼ í•œë„(8KB) ë¯¸ë§Œìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.
                mediaRecorder.start(400);

            } catch (err) {
                console.error('ë§ˆì´í¬ ì ‘ê·¼ ë˜ëŠ” ë…¹ìŒ ì‹œì‘ ì˜¤ë¥˜:', err);
                displayError('ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                if (socket) socket.close();
                cleanUp();
            }
        };

        socket.onerror = (event) => {
            console.error('WebSocket ì˜¤ë¥˜:', event);
            displayError('ì›¹ì†Œì¼“ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë‚˜ ì„¤ì •í•œ ì¿ í‚¤ ê°’ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            cleanUp();
        };

        socket.onclose = (event) => {
            console.log(`WebSocket ì—°ê²° ì¢…ë£Œ: ì½”ë“œ=${event.code}, ì´ìœ =${event.reason || 'ì—†ìŒ'}`);
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                cleanUp();
            }
        };
    });

    // 'ë…¹ìŒ ì¤‘ì§€' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    stopButton.addEventListener('click', cleanUp);

    // ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ë° ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜
    function cleanUp() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
        if (audioStream) {
            audioStream.getTracks().forEach(track => track.stop());
        }
        if (socket && socket.readyState < WebSocket.CLOSING) {
            socket.close();
        }

        updateStatus('ëŒ€ê¸° ì¤‘', '#6c757d');
        startButton.disabled = false;
        stopButton.disabled = true;

        mediaRecorder = null;
        audioStream = null;
        socket = null;
    }

    // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateStatus(message, color) {
        statusDiv.textContent = `ìƒíƒœ: ${message}`;
        statusDiv.style.color = color;
    }

    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function displayError(message) {
        errorDiv.textContent = `ì—ëŸ¬: ${message}`;
        updateStatus('ì˜¤ë¥˜ ë°œìƒ', '#dc3545');
    }
</script>

</body>
</html>